---
import { render, getCollection } from "astro:content";
import { Icon } from "astro-icon/components";
import Time from "$utils/time";
import Base from "$layouts/Base.astro";
import Heatmap from "$components/Heatmap.svelte";
import config from "$config";

const { locale = "zh-cn" } = Astro.params;

// Get preface content for current locale, sorted by timestamp (newest first)
const prefaces = (await getCollection("preface")).sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime());

// Get published notes for current locale, sorted by timestamp (newest first)
const notes = (await getCollection("note")).sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime());

// Get the most recent note and preface for display
const newest = notes[0];
const preface = prefaces[0];
// Render preface content if available, otherwise use empty object
const { Content } = preface ? await render(preface) : ({} as any);
---

<Base title="Home" {locale}>
	<main class="flex flex-col gap-5 sm:gap-20 flex-grow">
		<header class="flex items-center justify-center flex-wrap-reverse grow-0.6">
			{config.prologue && <article class="mr-a font-cursive font-thin text-size-xl sm:text-size-2xl line-height-loose whitespace-pre-line">{config.prologue}</article>}
			<Icon name="site-logo" size={100} is:inline />
		</header>

		{
			preface && (
				<section class="flex flex-col">
					<article class="markdown">
						<Content />
					</article>
					<a href="/preface" class="self-end my-2 text-size-sm c-secondary">
						—— {Time.date.locale(preface.data.timestamp, locale)}
					</a>
				</section>
			)
		}

		{
			newest && (
				<footer class="flex items-center justify-center flex-wrap-reverse gap-10">
					<Heatmap {locale} {notes} />

					<blockquote class="flex-grow">
						<h3>Newest Note</h3>
						<div class="flex flex-col sm:flex-row justify-between gap-1 mt-2">
							<a href='/note/${newest.id.split("/").slice(1).join("/")}' class="link">
								{newest.data.series ? `${newest.data.series} | ` : ""}
								{newest.data.title}
							</a>
							<div class="flex gap-1">
								{newest.data.tags?.map(tag => (
									<span class="c-remark text-size-sm">#{tag}</span>
								))}
							</div>
						</div>
						<time title={Time.full(newest.data.timestamp)} class="c-remark font-mono text-xs">
							{Time(newest.data.timestamp)}
						</time>
					</blockquote>
				</footer>
			)
		}
	</main>
</Base>
